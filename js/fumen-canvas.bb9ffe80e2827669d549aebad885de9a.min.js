const{decoder}=require("tetris-fumen");var colors={I:{normal:"#41afde",highlight1:"#3dc0fb",highlight2:"#3dc0fb",lighter:"#3dc0fb",light:"#43d3ff"},T:{normal:"#b451ac",highlight1:"#d161c9",highlight2:"#d161c9",lighter:"#d161c9",light:"#e56add"},S:{normal:"#66c65c",highlight1:"#75d96a",highlight2:"#7cd97a",lighter:"#7cd97a",light:"#88ee86"},Z:{normal:"#ef624d",highlight1:"#ff7866",highlight2:"#ff8778",lighter:"#fd7660",light:"#ff9484"},L:{normal:"#ef9535",highlight1:"#ffa94d",highlight2:"#ffae58",lighter:"#fea440",light:"#ffbf60"},J:{normal:"#1983bf",highlight1:"#1997e3",highlight2:"#1997e3",lighter:"#1997e3",light:"#1ba6f9"},O:{normal:"#f7d33e",highlight1:"#ffe34b",highlight2:"#ffe34b",lighter:"#ffe34b",light:"#fff952"},X:{normal:"#bbbbbb",highlight1:"#686868",highlight2:"#686868",lighter:"#bbbbbb",light:"#cccccc"},Empty:{normal:"#f3f3ed"}};function draw(u,o,l,e,r,a,f,p){var s=u.field,d,n,c,h=u.operation;function m(e){return i==e.x&&j==e.y}if(o==void 0){o=0;for(i=0;i<l;i++)for(j=0;j<23;j++)s.at(i,j)!="_"&&(o=Math.max(o,j)),h!=void 0&&h.positions().filter(m).length>0&&(o=Math.max(o,j));o+=2}d=e*l,n=o*e,c=document.createElement("canvas"),c.width=d,c.height=n;const t=c.getContext("2d");if(f?t.fillStyle="#00000000":t.fillStyle=p,t.fillRect(0,0,d,n),r){t.strokeStyle=a,t.strokeRect(0,0,d,n);for(i=0;i<l;i++)for(j=0;j<o;j++)t.fillStyle=a+"30",t.fillRect(i*e,n-(j+1)*e,1,e),t.fillRect(i*e,n-(j+1)*e,e,1)}for(i=0;i<l;i++)for(j=0;j<o;j++)s.at(i,j)!="_"&&(t.fillStyle=colors[s.at(i,j)].normal,t.fillRect(i*e,n-(j+1)*e,e,e),r&&(t.fillStyle=a+"40",t.fillRect(i*e,n-(j+1)*e,1,e),t.fillRect(i*e,n-(j+1)*e,e,1),t.fillRect((i+1)*e,n-(j+1)*e,1,e),t.fillRect(i*e,n-j*e,e,1)),s.at(i,j+1)=="_"&&(t.fillStyle=colors[s.at(i,j)].light,t.fillRect(i*e,n-(j+1)*e-e/5,e,e/5),r&&(t.fillStyle=a+"CC",t.fillRect(i*e,n-(j+1)*e-e/5,e,1),s.at(Math.max(0,i-1),j+1)=="_"?(t.fillStyle=a+"CC",t.fillRect(i*e,n-(j+1)*e-e/5,1,e/5)):(t.fillStyle=a+"FF",t.fillRect(i*e,n-(j+1)*e-e/5,1,e/5)),s.at(i+1,j+1)=="_"&&(t.fillStyle=a+"CC",t.fillRect((i+1)*e,n-(j+1)*e-e/5,1,e/5)))),r&&(t.fillStyle=a+"FF",s.at(Math.max(i-1,0),j)=="_"&&t.fillRect(i*e,n-(j+1)*e,1,e+1),s.at(i,j+1)=="_"&&t.fillRect(i*e,n-(j+1)*e,e+1,1),s.at(i+1,j)=="_"&&t.fillRect((i+1)*e,n-(j+1)*e,1,e+1),s.at(i,j-1)=="_"&&t.fillRect(i*e,n-j*e,e+1,1)));return c}function fumencanvas(e){var c=e.innerText,n,s,o,u,i,l,a,r,d,t;e.getAttribute("height")!=null?(n=e.getAttribute("height")):(n=5),e.getAttribute("width")!=null?(s=e.getAttribute("width")):(s=10),e.getAttribute("size")!=null?(o=e.getAttribute("size")):(o=22),e.getAttribute("grid")!=null?(u=e.getAttribute("grid"),i=!0):(i=!1),e.getAttribute("background")!=null?(l=e.getAttribute("background"),a=!1):(a=!0),r=[];for(let e of c.split("	"))r.push(...e.split(/\s/));for(let c of r)try{d=decoder.decode(c),canvas=draw(d[0],n,s,o,i,u,a,l),t=document.createElement("img"),t.src=canvas.toDataURL("image/png"),t.className="imageOutput",e.innerText='',e.appendChild(t)}catch(e){console.log(c,e)}}function formatFumen(){let e=document.getElementsByTagName("fumen");Array.from(e).forEach(e=>fumencanvas(e))}window.addEventListener("million:navigate",formatFumen),window.addEventListener("DOMContentLoaded",formatFumen)